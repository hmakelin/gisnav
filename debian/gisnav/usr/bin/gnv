#!/bin/bash

# Function to print usage
print_usage() {
    echo "Usage: gnv [cmp|sim] [sitl|hil] {start|stop|prepare|status|help|--help|-h}"
    echo ""
    echo "Commands:"
    echo "  start           Start services."
    echo "  stop            Stop services."
    echo "  status          Check services status."
    echo "  prepare         Setup services by preparing Docker containers."
    echo "  help|--help|-h  Show this help message."
    echo ""
    echo "Deployment types:"
    echo "  cmp             Companion computer deployment."
    echo "  sim             Simulation deployment."
    echo ""
    echo "  Note: You can choose to not provide the deployment type, in which case both types are deployed."
    echo ""
    echo "Deployment subtypes:"
    echo "  sitl            Software-in-the-loop. Default subtype if not provided."
    echo "  hil             Hardware-in-the-loop. (Note: HIL subtype is currently unsupported by 'gnv')."
    echo ""
    echo "Examples:"
    echo "  gnv start"
    echo "  GISNAV_COMPANION_HOST=raspberrypi.local gnv sim start"
    echo "  gnv cmp hil start"
}

# Function to manage tasks
manage_tasks() {
    local deployment_type=$1
    local deployment_subtype=$2
    shift 2

    # Define services to deploy in different deployment types
    local services_cmp="gisnav"
    local services_sim="px4"
    local services_dual="$services_cmp $services_sim"

    # Handle submode
    case "$deployment_subtype" in
        sitl)
            ;;
        hil)
            echo "WARNING: HIL subtype is unsupported."
            exit 1
            ;;
        *)
            echo "Unknown subtype: $deployment_subtype"
            print_usage
            exit 1
            ;;
    esac

    # Determine services to start/prepare based on deployment type
    local services=""
    if [ "$deployment_type" == "sim" ]; then
        services=$services_sim
    elif [ "$deployment_type" == "cmp" ]; then
        services=$services_cmp
    elif [ "$deployment_type" == "dual" ]; then
        services=$services_dual
    else
        echo "Unknown deployment type: $deployment_type"
        print_usage
        exit 1
    fi

    case "$1" in
        start)
            /usr/lib/gisnav/start.sh $services
            ;;
        stop)
            /usr/lib/gisnav/stop.sh $services
            ;;
        status)
            /usr/lib/gisnav/status.sh $services
            ;;
        prepare)
            /usr/lib/gisnav/prepare.sh $services
            ;;
        help|--help|-h)
            print_usage
            ;;
        *)
            echo "Unknown command: $1"
            print_usage
            exit 1
            ;;
    esac
}

# Check if enough arguments are provided
if [ $# -lt 1 ]; then
    print_usage
    exit 1
fi

# Determine defaults for deployment type and subtype if not provided
deployment_type="dual"
deployment_subtype="sitl"
command=""

if [ "$1" == "sim" ] || [ "$1" == "cmp" ]; then
    deployment_type=$1
    shift
fi

if [ "$1" == "sitl" ] || [ "$1" == "hil" ]; then
    deployment_subtype=$1
    shift
fi

if [ -n "$1" ]; then
    command=$1
    shift
else
    print_usage
    exit 1
fi

# Manage tasks based on provided arguments
manage_tasks $deployment_type $deployment_subtype $command "$@"
