Use ROS 2 launch system
____________________________________________________

:term:`ROS 2` provides a launch system that can be used to launch applications
consisting of multiple nodes with premade configurations.

This page describes how GISNav uses the launch system to help you when
developing locally or when making custom deployments.

Prerequisites
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. include:: _prerequisites_ros.rst

.. include:: _prerequisites_gisnav.rst

.. include:: _prerequisites_source_workspace.rst

Build colcon workspace
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. tab-set::

    .. tab-item:: Entire workspace
        :selected:

        .. code-block:: bash
            :caption: Build entire colcon workspace

            mkdir -p ~/colcon_ws
            colcon build
            source install/setup.bash

    .. tab-item:: GISNav package only
        :selected:

        .. code-block:: bash
            :caption: Build GISNav package

            mkdir -p ~/colcon_ws
            colcon build --packages-select gisnav
            source install/setup.bash

Launch GISNav for local development
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Assuming you have already installed the ``gisnav`` colcon package, you can launch with a single command:

.. tab-set::

    .. tab-item:: PX4
        :selected:

        .. code-block:: bash
            :caption: Launch GISNav for PX4

            ros2 launch gisnav px4.dev.launch.py

        Your shell should then start showing log messages generated by GISNav's nodes:

        .. code-block:: text
            :caption: Example output when launching GISNav for PX4

            hmakelin@hmakelin-Nitro-AN515-54:~/workspace/px4_ros_com_ros2$ ros2 launch gisnav px4.launch.py
            [INFO] [launch]: All log files can be found below /home/hmakelin/.ros/log/2022-12-14-13-55-31-751707-hmakelin-Nitro-AN515-54-1269819
            [INFO] [launch]: Default logging verbosity is set to INFO
            [INFO] [px4_node-1]: process started with pid [1269837]
            [INFO] [mock_gps_node-2]: process started with pid [1269839]
            [INFO] [map_node-3]: process started with pid [1269841]
            [INFO] [bbox_node-4]: process started with pid [1269843]
            [INFO] [pose_estimation_node-5]: process started with pid [1269845]
            [pose_estimation_node-5] [INFO] [1671026134.317154046] [pose_estimation_node]: ROS parameter "max_pitch" already declared with value "30".
            [pose_estimation_node-5] [INFO] [1671026134.317957668] [pose_estimation_node]: ROS parameter "min_match_altitude" already declared with value "50".
            [pose_estimation_node-5] [INFO] [1671026134.318823560] [pose_estimation_node]: ROS parameter "attitude_deviation_threshold" already declared with value "10".
            [pose_estimation_node-5] [INFO] [1671026134.319698017] [pose_estimation_node]: ROS parameter "export_position" already declared with value "".
            [pose_estimation_node-5] [INFO] [1671026134.326348362] [pose_estimation_node]: Loaded params:
            ...

    .. tab-item:: ArduPilot

        .. code-block:: bash
            :caption: Launch GISNav for ArduPilot

            ros2 launch gisnav ardupilot.dev.launch.py

        Your shell should then start showing log messages generated by GISNav's nodes:

        .. code-block:: text
            :caption: Example output when launching GISNav for ArduPilot

            hmakelin@hmakelin-Nitro-AN515-54:~/workspace/px4_ros_com_ros2$ ros2 launch gisnav ardupilot.launch.py
            [INFO] [launch]: All log files can be found below /home/hmakelin/.ros/log/2022-12-14-20-15-13-434747-hmakelin-Nitro-AN515-54-1299156
            [INFO] [launch]: Default logging verbosity is set to INFO
            [INFO] [ardupilot_node-1]: process started with pid [1299173]
            [INFO] [mock_gps_node-2]: process started with pid [1299175]
            [INFO] [map_node-3]: process started with pid [1299177]
            [INFO] [bbox_node-4]: process started with pid [1299179]
            [INFO] [pose_estimation_node-5]: process started with pid [1299181]
            [pose_estimation_node-5] [INFO] [1671048916.388314406] [pose_estimation_node]: ROS parameter "max_pitch" already declared with value "30".
            [pose_estimation_node-5] [INFO] [1671048916.389742861] [pose_estimation_node]: ROS parameter "min_match_altitude" already declared with value "50".
            [pose_estimation_node-5] [INFO] [1671048916.391036526] [pose_estimation_node]: ROS parameter "attitude_deviation_threshold" already declared with value "10".
            [pose_estimation_node-5] [INFO] [1671048916.392134461] [pose_estimation_node]: ROS parameter "export_position" already declared with value "".
            [pose_estimation_node-5] [INFO] [1671048916.398298326] [pose_estimation_node]: Loaded params:
            ...

.. seealso::
    See the `Creating Launch Files`_ tutorial for more information on the ROS 2 launch system

    .. _Creating Launch Files: https://docs.ros.org/en/foxy/Tutorials/Intermediate/Launch/Creating-Launch-Files.html


Run individual node
____________________________________________________

It is recommended that you :ref:`Launch from ROS launch file`. However, you can also launch individual nodes
and optionally provide launch values for ROS parameters from the YAML files in the ``launch/params/`` folder:

.. code-block:: bash
    :caption: Run :class:`.MapNode` with ``INFO`` log level and optional YAML parameter file

    cd ~/colcon_ws
    ros2 run gisnav map_node --ros-args --log-level info --params-file src/gisnav/launch/params/map_node.yaml

Your shell should then start showing log messages generated by :class:`.MapNode` at your chosen log level:

.. code-block:: text
    :caption: Example output when launching GISNav for PX4

    hmakelin@hmakelin-Nitro-AN515-54:~/workspace/px4_ros_com_ros2$ ros2 run gisnav map_node --ros-args --log-level info --params-file src/gisnav/launch/params/map_node.yaml
    [INFO] [1671026892.443398239] [map_node]: ROS parameter "layers" already declared with value "['imagery']".
    [INFO] [1671026892.444331459] [map_node]: Using default value "['']" for ROS parameter "styles".
    [INFO] [1671026892.445077047] [map_node]: ROS parameter "dem_layers" already declared with value "['osm-buildings']".
    [INFO] [1671026892.445934245] [map_node]: Using default value "['']" for ROS parameter "dem_styles".
    [INFO] [1671026892.446790070] [map_node]: Using default value "EPSG:4326" for ROS parameter "srs".
    [INFO] [1671026892.447671806] [map_node]: Using default value "False" for ROS parameter "transparency".
    [INFO] [1671026892.448461329] [map_node]: Using default value "image/jpeg" for ROS parameter "format".
    [INFO] [1671026892.449245454] [map_node]: Using default value "0.85" for ROS parameter "map_overlap_update_threshold".
    [ERROR] [1671026893.054366929] [map_node]: Connecting to WMS endpoint...
    [ERROR] [1671026893.058634673] [map_node]: Could not connect to WMS endpoint, trying again in 10s...
    ...
